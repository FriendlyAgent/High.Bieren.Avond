<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>High Bieren Spel</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f7fa;
      color: #2e3a59;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 900px;
      margin: auto;
      padding: 2rem;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    }
    h1, h2, h3 {
      text-align: center;
      color: #374785;
    }
    .player-row {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      align-items: center;
    }
    input {
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      flex: 1;
    }
    button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background-color: #45a049;
    }
    .score-buttons button {
      margin: 0.2rem;
      padding: 0.5rem 1rem;
      background-color: #e0e0e0;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
    }
    .score-buttons button.selected {
      background-color: #ff9800;
      color: white;
    }
    .score-buttons button.bounce {
      transform: scale(1.2);
    }
    .dice-animation {
      font-size: 2rem;
      animation: shake 1s ease-in-out;
      text-align: center;
    }
    @keyframes shake {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(10deg); }
      50% { transform: rotate(-10deg); }
      75% { transform: rotate(10deg); }
    }
    @media (max-width: 600px) {
      .player-row {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container" id="app"></div>
  <script>
    const app = document.getElementById('app');

let state = {
  players: [],
  round: 0,
  currentBeer: null,
  scores: [],
  startTime: Date.now()
};

function renderSetup() {
  app.innerHTML = `
    <h1>High Bieren</h1>
    <h2>📜 Spelregels</h2>
    <ul>
      <li>Iedere speler neemt één soort bier mee voor elke deelnemer.</li>
      <li>Per ronde wordt willekeurig één bier gekozen.</li>
      <li>Iedere speler beoordeelt het gekozen bier met een score van 1 t/m 10.</li>
      <li>Geen score = afvaller.</li>
      <li>Na alle rondes worden gemiddelden berekend en winnaars bepaald.</li>
    </ul>
    <h2>Spelers</h2>
    <div id="players">
      ${state.players.map((p, i) => `
        <div class="player-row">
          <input placeholder="Naam" value="${p.name}" oninput="updatePlayer(${i}, 'name', this.value)" />
          <input placeholder="Bier" value="${p.beer}" oninput="updatePlayer(${i}, 'beer', this.value)" />
          <button onclick="removePlayer(${i})">🗑</button>
        </div>
      `).join('')}
    </div>
    <button onclick="addPlayer()">+ Voeg Speler Toe</button>
    <button onclick="startGame()">✅ Start Spel</button>
  `;
}

function updatePlayer(i, field, value) {
  state.players[i][field] = value;
}

function addPlayer() {
  state.players.push({ name: '', beer: '', eliminated: false });
  renderSetup();
}

function removePlayer(i) {
  state.players.splice(i, 1);
  renderSetup();
}

function startGame() {
  if (state.players.length < 2) return alert('Minimaal 2 spelers vereist.');
  if (!state.players.every(p => p.name && p.beer)) return alert('Alle velden moeten ingevuld zijn.');
  state.players.forEach(p => { p.eliminated = false; });
  state.round = 0;
  state.scores = [];
  nextRound();
}

function nextRound() {
  const played = state.scores.map(r => r.beer);
  const remaining = state.players.filter(p => !played.includes(p.beer));
  if (remaining.length === 0) return renderResults();

  state.round++;
  state.currentBeer = remaining[Math.floor(Math.random() * remaining.length)];
  renderRound();
}

let selectedScores = {};

function renderRound() {
  selectedScores = {};
  const activePlayers = state.players.filter(p => !p.eliminated);
  app.innerHTML = `
    <h2>Ronde ${state.round}</h2>
    <div class="dice-animation">🎲</div>
    <h3>${state.currentBeer.beer}</h3>
    <p>Ingebracht door: ${state.currentBeer.name}</p>
    <form id="scoreForm">
      ${activePlayers.map(p => `
        <div>
          <strong>${p.name}</strong>
          <div class="score-buttons" data-player="${p.name}">
            ${[...Array(10).keys()].map(i => `
              <button type="button" data-score="${i + 1}">${i + 1}</button>
            `).join('')}
          </div>
        </div>
      `).join('')}
      <br><button type="submit">✅ Bevestig Ronde</button>
    </form>
  `;

  document.querySelectorAll('.score-buttons').forEach(group => {
    group.addEventListener('click', function(e) {
      if (e.target.tagName === 'BUTTON') {
        const score = parseInt(e.target.dataset.score);
        const player = group.dataset.player.trim().toLowerCase();
        selectedScores[player] = score;
        group.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
        e.target.classList.add('selected');
        e.target.classList.add('bounce');
        setTimeout(() => e.target.classList.remove('bounce'), 300);
      }
    });
  });

  document.getElementById('scoreForm').addEventListener('submit', function(e) {
    e.preventDefault();
    confirmRound();
  });
}

function confirmRound() {
  const round = {
    beer: state.currentBeer.beer,
    owner: state.currentBeer.name,
    scores: [],
    eliminated: []
  };

  for (const p of state.players) {
    if (p.eliminated) continue;
    if (selectedScores[p.name.trim().toLowerCase()]) {
      round.scores.push({ player: p.name, score: selectedScores[p.name.trim().toLowerCase()] });
    } else {
      p.eliminated = true;
      round.eliminated.push(p.name);
    }
  }

  state.scores.push(round);
  nextRound();
}

function renderResults() {
  const totalTime = ((Date.now() - state.startTime) / 1000).toFixed(0);
  const avgScoreByJudge = {};
  const allScores = {};
  const afvallers = [];
  const rondeVanAfval = {};

  state.scores.forEach((round, index) => {
    round.eliminated.forEach(name => {
      afvallers.push(name);
      rondeVanAfval[name] = index + 1;
    });

    round.scores.forEach(s => {
      if (!allScores[round.beer]) allScores[round.beer] = [];
      allScores[round.beer].push(s.score);

      if (!avgScoreByJudge[s.player]) avgScoreByJudge[s.player] = { total: 0, count: 0, given: [] };
      avgScoreByJudge[s.player].total += s.score;
      avgScoreByJudge[s.player].count++;
      avgScoreByJudge[s.player].given.push({ beer: round.beer, score: s.score });
    });
  });

  const avg = Object.entries(allScores).map(([beer, scores]) => {
    const owner = state.players.find(p => p.beer === beer).name;
    const average = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2);
    return { beer, average, owner };
  }).sort((a, b) => b.average - a.average);

  const volhouders = state.players.filter(p => !p.eliminated);
  const earliestRound = Math.min(...Object.values(rondeVanAfval));
  const laffeBorrelaars = afvallers.filter(name => rondeVanAfval[name] === earliestRound);
  const lafste = laffeBorrelaars.length ? laffeBorrelaars : null;

  const bestBeer = avg[0];
  const worstBeer = avg[avg.length - 1];

  const cards = `
    <div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin-bottom: 2rem;">
      <div style="flex:1; min-width: 250px; background:#e8f5e9; padding:1rem; border-radius:10px; text-align:center;">
        <h3>🏆 Beste Bier</h3>
        <p><strong>${bestBeer.beer}</strong><br/>Gemiddelde score: ${bestBeer.average}<br/>Door: ${bestBeer.owner}</p>
      </div>
      <div style="flex:1; min-width: 250px; background:#ffebee; padding:1rem; border-radius:10px; text-align:center;">
        <h3>💀 Slechtste Bier</h3>
        <p><strong>${worstBeer.beer}</strong><br/>Gemiddelde score: ${worstBeer.average}<br/>Door: ${worstBeer.owner}</p>
      </div>
      <div style="flex:1; min-width: 250px; background:#e3f2fd; padding:1rem; border-radius:10px; text-align:center;">
        <h3>💪 Volhouders</h3>
        <p>${volhouders.length > 0 ? volhouders.map(p => p.name).join(', ') : 'Geen'}</p>
      </div>
      ${lafste ? `
      <div style="flex:1; min-width: 250px; background:#fbe9e7; padding:1rem; border-radius:10px; text-align:center;">
        <h3>😵 Lafste Borrelaar(s)</h3>
        ${lafste.map(n => `<p>${n} (ronde ${rondeVanAfval[n]})</p>`).join('')}
      </div>` : ''}
    </div>
  `;

  const fullRanking = `
    <h3>📊 Volledige Bier Ranking</h3>
    <ol>
      ${avg.map((b, i) => `<li><strong>#${i + 1}</strong> - ${b.beer} (${b.average}) door ${b.owner}</li>`).join('')}
    </ol>
  `;

  const judgeDetails = `
    <h3>📈 Gedetailleerde Beoordelaarsstatistieken</h3>
    <ul style="columns: 2; -webkit-columns: 2; -moz-columns: 2;">
      ${Object.entries(avgScoreByJudge).map(([name, data]) => `
        <li style="margin-bottom:1rem;"><strong>${name}</strong>: Gemiddelde ${ (data.total / data.count).toFixed(2) }
          <ul>
            ${data.given.map(g => `<li>${g.beer}: ${g.score}</li>`).join('')}
          </ul>
        </li>
      `).join('')}
    </ul>
  `;

  app.innerHTML = `
    <h1 style="text-align:center">🏁 Eindresultaat</h1>
    ${cards}
    ${fullRanking}
    ${judgeDetails}
    <h3>⏱️ Totale speeltijd</h3>
    <p>${Math.floor(totalTime / 60)} minuten en ${totalTime % 60} seconden</p>
    <div style="text-align:center; margin-top:2rem">
      <button onclick="location.reload()">🔁 Opnieuw Spelen</button>
    </div>
  `;
}

renderSetup();
  </script>
</body>
</html>
