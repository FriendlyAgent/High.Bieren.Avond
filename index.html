<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>High Bieren Spel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
    }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    @keyframes slideIn {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .slide-animation {
      animation: slideIn 0.15s ease-out;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
    }
    .pulse-animation {
      animation: pulse 0.5s ease-in-out infinite;
    }
    @keyframes glow {
      0%, 100% { 
        box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        transform: scale(1);
      }
      50% { 
        box-shadow: 0 0 40px rgba(251, 191, 36, 0.8);
        transform: scale(1.02);
      }
    }
    .glow-animation {
      animation: glow 1s ease-in-out infinite;
    }
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }
    .shimmer {
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
      background-size: 1000px 100%;
      animation: shimmer 2s infinite;
    }
    @keyframes sparkle {
      0%, 100% { opacity: 0; transform: scale(0); }
      50% { opacity: 1; transform: scale(1); }
    }
    .sparkle {
      animation: sparkle 0.6s ease-in-out;
    }
    .bounce-animation {
      animation: bounce 0.3s;
    }
    @keyframes bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    
    /* Settings menu styles */
    .settings-menu {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }
    
    .settings-toggle {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .settings-panel {
      position: absolute;
      top: 60px;
      right: 0;
      width: 280px;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      transform: translateY(-10px);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .settings-panel.open {
      transform: translateY(0);
      opacity: 1;
      visibility: visible;
    }
    
    /* Dark mode slider */
    .dark-mode-slider {
      position: relative;
      width: 60px;
      height: 30px;
      background: #cbd5e1;
      border-radius: 15px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    
    .dark-mode-slider.active {
      background: #3b82f6;
    }
    
    .dark-mode-slider::before {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .dark-mode-slider.active::before {
      transform: translateX(30px);
    }
    
    /* Continue button animations */
    @keyframes buttonAppear {
      0% {
        opacity: 0;
        transform: translateY(20px) scale(0.3) rotateX(90deg);
      }
      50% {
        opacity: 1;
        transform: translateY(-5px) scale(1.1) rotateX(-10deg);
      }
      70% {
        transform: translateY(3px) scale(0.95) rotateX(5deg);
      }
      100% {
        opacity: 1;
        transform: translateY(0) scale(1) rotateX(0deg);
      }
    }
    
    @keyframes buttonFloat {
      0%, 100% {
        transform: translateY(0px) scale(1);
      }
      25% {
        transform: translateY(-3px) scale(1.02);
      }
      75% {
        transform: translateY(3px) scale(0.98);
      }
    }
    
    @keyframes pulseGlow {
      0%, 100% {
        box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4), inset 0 0 20px rgba(255, 255, 255, 0.1);
      }
      50% {
        box-shadow: 0 4px 30px rgba(34, 197, 94, 0.8), inset 0 0 30px rgba(255, 255, 255, 0.2);
      }
    }
    
    .button-appear {
      animation: buttonAppear 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
    }
    
    .button-animated {
      animation: buttonFloat 3s ease-in-out infinite, pulseGlow 2s ease-in-out infinite;
    }
    
    @keyframes slideCardLeft {
      from {
        transform: translateX(0);
      }
      to {
        transform: translateX(-30px);
      }
    }
    
    @media (min-width: 640px) {
      @keyframes slideCardLeft {
        from {
          transform: translateX(0);
        }
        to {
          transform: translateX(-60px);
        }
      }
    }
    
    .card-slide-left {
      animation: slideCardLeft 0.6s ease-out forwards;
    }
    
    /* Print styles - Completely different layout for print */
    @media print {
      @page {
        margin: 20mm;
        size: A4;
      }
      
      /* Hide web elements, show print elements */
      .no-print,
      .settings-menu,
      button {
        display: none !important;
      }
      
      .screen-only {
        display: none !important;
      }
      
      .print-only {
        display: block !important;
      }
      
      /* Basic print setup */
      body {
        background: white !important;
        color: black !important;
        font-family: 'Times New Roman', serif !important;
        font-size: 11pt !important;
        line-height: 1.3 !important;
      }
      
      .container {
        max-width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      
      /* Print header */
      .print-header {
        text-align: center;
        border-bottom: 2pt solid black;
        padding-bottom: 10pt;
        margin-bottom: 20pt;
      }
      
      .print-title {
        font-size: 24pt !important;
        font-weight: bold !important;
        margin-bottom: 5pt !important;
      }
      
      .print-subtitle {
        font-size: 12pt !important;
        color: #666 !important;
      }
      
      /* Print table styles */
      .print-table {
        width: 100%;
        border-collapse: collapse;
        margin: 15pt 0;
        page-break-inside: avoid;
      }
      
      .print-table th,
      .print-table td {
        border: 1pt solid black;
        padding: 6pt;
        text-align: left;
        vertical-align: top;
      }
      
      .print-table th {
        background: #f0f0f0 !important;
        font-weight: bold;
      }
      
      /* Print section headers */
      .print-section {
        margin: 20pt 0 10pt 0;
        page-break-after: avoid;
      }
      
      .print-section h2 {
        font-size: 16pt !important;
        font-weight: bold !important;
        border-bottom: 1pt solid black;
        padding-bottom: 3pt;
        margin-bottom: 10pt;
      }
      
      .print-section h3 {
        font-size: 14pt !important;
        font-weight: bold !important;
        margin: 10pt 0 5pt 0;
      }
      
      /* Hide web content when printing, show only print layout */
      .bg-white.dark\\:bg-gray-800.rounded-2xl > *:not(.print-only) {
        display: none !important;
      }
      
      /* Print lists */
      .print-list {
        margin: 10pt 0;
      }
      
      .print-list-item {
        margin: 3pt 0;
        padding-left: 15pt;
        text-indent: -15pt;
      }
      
      /* Print summary boxes */
      .print-summary {
        border: 2pt solid black;
        padding: 10pt;
        margin: 15pt 0;
        page-break-inside: avoid;
      }
      
      .print-summary h3 {
        margin-top: 0 !important;
        font-size: 14pt !important;
        font-weight: bold !important;
      }
      
      /* Page breaks */
      .page-break {
        page-break-before: always;
      }
      
      /* Two column layout for some sections */
      .print-two-column {
        column-count: 2;
        column-gap: 20pt;
        column-rule: 1pt solid #ccc;
      }
      
      /* Remove all styling from original elements */
      * {
        border-radius: 0 !important;
        box-shadow: none !important;
        background-image: none !important;
        animation: none !important;
        transition: none !important;
        transform: none !important;
      }
      
      .fas {
        display: none !important;
      }
    }
    
  </style>
</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-50 dark:from-gray-900 dark:to-gray-800 min-h-screen transition-colors duration-300">
  <!-- Always visible settings menu -->
  <div class="settings-menu">
    <div class="settings-toggle bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700" onclick="toggleSettingsPanel()">
      <i class="fas fa-cog text-gray-600 dark:text-gray-400"></i>
    </div>
    <div class="settings-panel bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700" id="settingsPanel">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">
        <i class="fas fa-cog mr-2"></i>Instellingen
      </h3>
      
      <div class="space-y-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <i class="fas fa-moon text-gray-600 dark:text-gray-400"></i>
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Dark Mode</span>
          </div>
          <div class="dark-mode-slider" id="darkModeSlider" onclick="toggleDarkMode()">
          </div>
        </div>
        
        <div class="border-t border-gray-200 dark:border-gray-600 pt-4">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Thema</span>
          </div>
          <div class="text-xs text-gray-500 dark:text-gray-400">
            ${state.darkMode ? 'Donker thema actief' : 'Licht thema actief'}
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="container mx-auto max-w-5xl p-2 sm:p-4" id="app"></div>
  <script>
    const app = document.getElementById('app');

let state = {
  players: [],
  round: 0,
  currentBeer: null,
  scores: [],
  startTime: Date.now(),
  roundHistory: [], // Store state after each round
  darkMode: localStorage.getItem('darkMode') === 'true' || false
};

function renderSetup() {
  app.innerHTML = `
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-4 sm:p-8 mt-4 sm:mt-8 relative">
      <h1 class="text-3xl sm:text-5xl font-bold text-center text-amber-700 dark:text-amber-400 mb-6 sm:mb-8">
        <i class="fas fa-beer text-amber-600 dark:text-amber-400"></i> High Bieren
      </h1>
      
      <div class="bg-amber-50 dark:bg-gray-700 rounded-xl p-4 sm:p-6 mb-6 sm:mb-8">
        <h2 class="text-xl sm:text-2xl font-semibold text-amber-800 dark:text-amber-400 mb-4">
          <i class="fas fa-scroll"></i> Spelregels
        </h2>
        <ul class="space-y-2 text-sm sm:text-base text-gray-700 dark:text-gray-300">
          <li class="flex items-start">
            <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
            <span>Iedere speler neemt één soort bier mee voor elke deelnemer.</span>
          </li>
          <li class="flex items-start">
            <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
            <span>Per ronde wordt willekeurig één bier gekozen.</span>
          </li>
          <li class="flex items-start">
            <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
            <span>Iedere speler beoordeelt het gekozen bier met een score van 1 t/m 10.</span>
          </li>
          <li class="flex items-start">
            <i class="fas fa-times-circle text-red-500 mt-1 mr-3"></i>
            <span>Geen score = afvaller.</span>
          </li>
          <li class="flex items-start">
            <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
            <span>Na alle rondes worden gemiddelden berekend en winnaars bepaald.</span>
          </li>
        </ul>
      </div>

      <h2 class="text-2xl sm:text-3xl font-semibold text-gray-800 dark:text-gray-200 mb-6">
        <i class="fas fa-users"></i> Spelers
      </h2>
      
      <div class="space-y-3" id="players">
        ${state.players.map((p, i) => `
          <div class="flex flex-col sm:flex-row gap-3 bg-gray-50 dark:bg-gray-700 p-3 sm:p-4 rounded-lg">
            <input 
              placeholder="Naam speler" 
              value="${p.name}" 
              oninput="updatePlayer(${i}, 'name', this.value)"
              class="flex-1 px-3 sm:px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:border-amber-500 focus:outline-none transition-colors text-sm sm:text-base dark:bg-gray-800 dark:text-gray-300 dark:placeholder-gray-400"
            />
            <input 
              placeholder="Naam bier" 
              value="${p.beer}" 
              oninput="updatePlayer(${i}, 'beer', this.value)"
              class="flex-1 px-3 sm:px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:border-amber-500 focus:outline-none transition-colors text-sm sm:text-base dark:bg-gray-800 dark:text-gray-300 dark:placeholder-gray-400"
            />
            <button 
              onclick="removePlayer(${i})"
              class="bg-red-500 hover:bg-red-600 text-white px-3 sm:px-4 py-2 rounded-lg transition-colors self-start sm:self-auto"
            >
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `).join('')}
      </div>
      
      <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 mt-6">
        <button 
          onclick="addPlayer()"
          class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 sm:px-6 rounded-lg transition-all transform hover:scale-105 text-sm sm:text-base"
        >
          <i class="fas fa-plus-circle"></i> Voeg Speler Toe
        </button>
        <button 
          onclick="startGame()"
          class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 sm:px-6 rounded-lg transition-all transform hover:scale-105 text-sm sm:text-base"
        >
          <i class="fas fa-play"></i> Start Spel
        </button>
      </div>
      
      <div class="mt-4 text-center">
        <button 
          onclick="fillDemoData()"
          class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg transition-all transform hover:scale-105 text-sm sm:text-base"
        >
          <i class="fas fa-flask"></i> Demo Mode (10 spelers)
        </button>
      </div>
    </div>
  `;
}

function updatePlayer(i, field, value) {
  state.players[i][field] = value;
}

function addPlayer() {
  state.players.push({ name: '', beer: '', eliminated: false });
  renderSetup();
}

function removePlayer(i) {
  state.players.splice(i, 1);
  renderSetup();
}

function fillDemoData() {
  const demoPlayers = [
    { name: 'Jeroen', beer: 'Heineken' },
    { name: 'Sophie', beer: 'La Chouffe' },
    { name: 'Max', beer: 'Duvel' },
    { name: 'Emma', beer: 'Tripel Karmeliet' },
    { name: 'Lucas', beer: 'Grolsch' },
    { name: 'Lisa', beer: 'Amstel' },
    { name: 'Thomas', beer: 'Westmalle Dubbel' },
    { name: 'Julia', beer: 'Brand' },
    { name: 'Bram', beer: 'Hertog Jan' },
    { name: 'Anna', beer: 'Leffe Blond' }
  ];
  
  state.players = demoPlayers.map(p => ({ ...p, eliminated: false }));
  renderSetup();
}

function saveRoundHistory() {
  // Deep clone current state
  const currentState = {
    players: JSON.parse(JSON.stringify(state.players)),
    round: state.round,
    currentBeer: state.currentBeer ? JSON.parse(JSON.stringify(state.currentBeer)) : null,
    scores: JSON.parse(JSON.stringify(state.scores)),
    selectedScores: JSON.parse(JSON.stringify(selectedScores)),
    timestamp: Date.now() // Add timestamp for round duration calculation
  };
  state.roundHistory.push(currentState);
}

function goBackOneRound() {
  if (state.roundHistory.length === 0) return;
  
  // Restore previous state
  const previousState = state.roundHistory.pop();
  state.players = previousState.players;
  state.round = previousState.round;
  state.currentBeer = previousState.currentBeer;
  state.scores = previousState.scores;
  selectedScores = previousState.selectedScores || {};
  
  // Flag that we're restoring from history
  window.restoringFromHistory = true;
  
  // If we're back to round 0, show setup
  if (state.round === 0) {
    renderSetup();
  } else {
    renderRound();
  }
}

function startGame() {
  if (state.players.length < 2) return alert('Minimaal 2 spelers vereist.');
  if (!state.players.every(p => p.name && p.beer)) return alert('Alle velden moeten ingevuld zijn.');
  state.players.forEach(p => { p.eliminated = false; });
  state.round = 0;
  state.scores = [];
  state.roundHistory = []; // Reset history
  
  // Save initial state
  saveRoundHistory();
  
  nextRound();
}

function nextRound() {
  const played = state.scores.map(r => r.beer);
  const remaining = state.players.filter(p => !played.includes(p.beer));
  if (remaining.length === 0) return renderResults();

  state.round++;
  state.currentBeer = remaining[Math.floor(Math.random() * remaining.length)];
  showLootboxAnimation(remaining);
}

let selectedScores = {};

function showLootboxAnimation(beers) {
  const activePlayers = state.players.filter(p => !p.eliminated);
  const totalRounds = state.players.length;
  const completedRounds = state.scores.length;
  const progressPercentage = (completedRounds / totalRounds) * 100;
  
  app.innerHTML = `
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-4 sm:p-8 mt-4 sm:mt-8">
      <h2 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 dark:text-gray-200 mb-4 sm:mb-6">
        Ronde ${state.round}
      </h2>
      
      <!-- Progress Bar -->
      <div class="mb-6">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm sm:text-base font-medium text-gray-700 dark:text-gray-300">Voortgang</span>
          <span class="text-sm sm:text-base font-medium text-gray-700 dark:text-gray-300">${completedRounds}/${totalRounds} rondes</span>
        </div>
        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-3 sm:h-4">
          <div class="bg-gradient-to-r from-amber-400 to-orange-500 h-3 sm:h-4 rounded-full transition-all duration-500 ease-out" style="width: ${progressPercentage}%"></div>
        </div>
        <div class="flex justify-between mt-2">
          ${Array.from({length: totalRounds}, (_, i) => `
            <div class="flex flex-col items-center">
              <div class="w-3 h-3 sm:w-4 sm:h-4 rounded-full ${i < completedRounds ? 'bg-green-500' : i === completedRounds ? 'bg-amber-500 pulse-animation' : 'bg-gray-300 dark:bg-gray-600'}"></div>
              <span class="text-xs text-gray-500 dark:text-gray-400 mt-1">${i + 1}</span>
            </div>
          `).join('')}
        </div>
      </div>
      
      <div class="text-center">
        <h3 class="text-lg sm:text-2xl font-semibold text-amber-700 dark:text-amber-400 mb-4 sm:mb-6">
          <i class="fas fa-dice"></i> Willekeurige Selectie
        </h3>
        
        <!-- Lootbox container -->
        <div class="relative mx-auto max-w-2xl">
          <!-- Background glow effect -->
          <div class="absolute inset-0 bg-gradient-to-r from-amber-200 via-yellow-200 to-amber-200 dark:from-amber-600 dark:via-yellow-600 dark:to-amber-600 rounded-2xl blur-xl opacity-50"></div>
          
          <!-- Main lootbox -->
          <div class="relative bg-gradient-to-br from-amber-100 to-orange-100 dark:from-amber-900 dark:to-orange-900 rounded-2xl p-4 sm:p-8 border-4 border-amber-300 dark:border-amber-600 shadow-2xl">
            <!-- Decorative corners -->
            <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-amber-500 dark:border-amber-400 rounded-tl-xl"></div>
            <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-amber-500 dark:border-amber-400 rounded-tr-xl"></div>
            <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-amber-500 dark:border-amber-400 rounded-bl-xl"></div>
            <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-amber-500 dark:border-amber-400 rounded-br-xl"></div>
            
            <!-- Selection window -->
            <div class="relative h-40 sm:h-48 overflow-hidden bg-gradient-to-br from-amber-700 to-yellow-600 rounded-xl shadow-inner">
              <div class="absolute inset-0 shimmer pointer-events-none z-10"></div>
              <div id="beerSlider" class="absolute inset-0 flex items-center justify-center p-4 sm:p-8">
                <!-- Card will be inserted here -->
              </div>
            </div>
            
            <!-- Indicator arrows -->
            <div class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1 sm:-translate-x-2">
              <i class="fas fa-caret-right text-2xl sm:text-4xl text-amber-500 dark:text-amber-400"></i>
            </div>
            <div class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-1 sm:translate-x-2">
              <i class="fas fa-caret-left text-2xl sm:text-4xl text-amber-500 dark:text-amber-400"></i>
            </div>
          </div>
        </div>
        
        <!-- Loading dots -->
        <div class="mt-6 flex justify-center gap-2">
          <div class="w-3 h-3 bg-amber-400 rounded-full animate-pulse"></div>
          <div class="w-3 h-3 bg-amber-400 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
          <div class="w-3 h-3 bg-amber-400 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
        </div>
      </div>
      
      <!-- Active Players Section -->
      <div class="bg-blue-50 dark:bg-gray-700 rounded-xl p-4 sm:p-6 mt-6">
        <h3 class="text-lg sm:text-xl font-semibold text-blue-800 dark:text-blue-400 mb-3 text-center">
          <i class="fas fa-users"></i> Actieve Spelers Deze Ronde
        </h3>
        <div class="flex flex-wrap justify-center gap-2 sm:gap-3">
          ${activePlayers.map(p => `
            <div class="bg-white dark:bg-gray-800 rounded-lg px-3 py-2 border-2 border-blue-200 dark:border-blue-600 flex items-center gap-2">
              <i class="fas fa-user-circle text-blue-600 dark:text-blue-400"></i>
              <span class="text-sm sm:text-base font-medium text-blue-800 dark:text-blue-400">${p.name}</span>
            </div>
          `).join('')}
        </div>
        <p class="text-center text-blue-600 dark:text-blue-400 mt-3 text-sm sm:text-base">
          ${activePlayers.length} ${activePlayers.length === 1 ? 'speler doet' : 'spelers doen'} mee
        </p>
      </div>
    </div>
  `;

  const slider = document.getElementById('beerSlider');
  const selectedIndex = beers.indexOf(state.currentBeer);
  
  // Create a shuffled array that ensures our selected beer is not at the end
  let shuffledBeers = [...beers];
  for (let i = shuffledBeers.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffledBeers[i], shuffledBeers[j]] = [shuffledBeers[j], shuffledBeers[i]];
  }
  
  // Create animation sequence with fake-out
  const animationSequence = [];
  const totalDuration = 5000; // 5 seconds total
  const cycles = 15; // Number of cycles through beers
  let rollSteps = 0; // Will be set later for the fake-out
  
  // Regular cycling
  for (let i = 0; i < cycles; i++) {
    animationSequence.push(shuffledBeers[i % shuffledBeers.length]);
  }
  
  // Add fake-out sequence
  // First, find a beer that's not the selected one for the fake-out
  const fakeOutBeer = beers.find(b => b !== state.currentBeer) || beers[0];
  animationSequence.push(fakeOutBeer); // Land on fake beer
  
  // Now randomly roll forward or backward to the actual beer
  const fakeOutIndex = beers.indexOf(fakeOutBeer);
  const targetIndex = beers.indexOf(state.currentBeer);
  rollSteps = Math.floor(Math.random() * 3) + 2; // Roll 2-4 steps
  
  if (Math.random() > 0.5) {
    // Roll forward - start from the next beer after fake-out
    for (let i = 1; i <= rollSteps; i++) {
      const stepIndex = (fakeOutIndex + i) % beers.length;
      animationSequence.push(beers[stepIndex]);
    }
  } else {
    // Roll backward - start from the previous beer before fake-out
    for (let i = 1; i <= rollSteps; i++) {
      const stepIndex = (fakeOutIndex - i + beers.length) % beers.length;
      animationSequence.push(beers[stepIndex]);
    }
  }
  
  // Final push to ensure we end on the correct beer
  animationSequence.push(state.currentBeer);
  
  let currentStep = 0;
  const animationSpeed = totalDuration / animationSequence.length;
  
  function animate() {
    if (currentStep < animationSequence.length) {
      const currentBeer = animationSequence[currentStep];
      const isNearEnd = currentStep >= animationSequence.length - 3;
      const isFinal = currentStep === animationSequence.length - 1;
      
      slider.innerHTML = `
        <div class="w-full h-full flex items-center justify-center slide-animation">
          <div class="relative w-36 sm:w-64 h-20 sm:h-32 ${isNearEnd ? 'pulse-animation' : ''}">
            <!-- Beer card -->
            <div class="absolute inset-0 bg-gradient-to-br from-amber-100 to-orange-100 rounded-lg border-2 border-amber-400 shadow-lg transform ${isFinal ? 'scale-95 sm:scale-105' : 'scale-90 sm:scale-100'}">
              <!-- Beer icon background -->
              <div class="absolute top-1 sm:top-2 right-1 sm:right-2 opacity-20">
                <i class="fas fa-beer text-xl sm:text-4xl text-amber-600"></i>
              </div>
              
              <!-- Content -->
              <div class="relative h-full flex flex-col justify-center items-center p-1 sm:p-4">
                <h3 class="text-sm sm:text-2xl font-bold text-amber-800 text-center mb-0 sm:mb-1">
                  ${currentBeer.beer}
                </h3>
                <p class="text-xs sm:text-sm text-gray-600 flex items-center gap-1">
                  <i class="fas fa-user-circle text-xs hidden sm:inline"></i>
                  <span class="text-xs">${currentBeer.name}</span>
                </p>
              </div>
              
              ${isFinal ? `
                <!-- Final selection indicator -->
                <div class="absolute -top-3 -right-3 bg-yellow-400 rounded-full p-2 shadow-lg">
                  <i class="fas fa-star text-white"></i>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
      
      currentStep++;
      
      // Slow down at the end for dramatic effect
      let delay = animationSpeed;
      if (currentStep === animationSequence.length - rollSteps - 1) {
        // Big pause on the fake-out beer
        delay = animationSpeed * 8;
      } else if (currentStep > animationSequence.length - rollSteps - 1) {
        // Slower rolling after fake-out
        delay = animationSpeed * 3;
      }
      setTimeout(animate, delay);
    } else {
      // Show final selection with glow effect
      setTimeout(() => {
        slider.innerHTML = `
          <div class="w-full h-full flex items-center justify-center">
            <div class="relative w-36 sm:w-64 h-20 sm:h-32 glow-animation">
              <!-- Beer card -->
              <div class="absolute inset-0 bg-gradient-to-br from-yellow-100 to-amber-100 rounded-lg border-3 border-yellow-400 shadow-2xl transform scale-90 sm:scale-110">
                <!-- Beer icon background -->
                <div class="absolute top-1 sm:top-2 right-1 sm:right-2 opacity-20">
                  <i class="fas fa-beer text-2xl sm:text-4xl text-amber-600"></i>
                </div>
                
                <!-- Content -->
                <div class="relative h-full flex flex-col justify-center items-center p-1 sm:p-4">
                  <h3 class="text-sm sm:text-2xl font-bold text-amber-800 text-center mb-0 sm:mb-1">
                    ${state.currentBeer.beer}
                  </h3>
                  <p class="text-xs sm:text-sm text-gray-600 flex items-center gap-1">
                    <i class="fas fa-user-circle text-xs hidden sm:inline"></i>
                    <span class="text-xs">${state.currentBeer.name}</span>
                  </p>
                </div>
                
                <!-- Winner badge -->
                <div class="absolute -top-4 left-1/2 transform -translate-x-1/2 bg-gradient-to-br from-yellow-400 to-amber-500 rounded-full px-4 py-1 shadow-lg">
                  <span class="text-white font-bold text-sm">SELECTED!</span>
                </div>
                
                <!-- Trophy -->
                <div class="absolute -bottom-3 -right-3 bg-yellow-400 rounded-full p-2 shadow-lg sparkle">
                  <i class="fas fa-trophy text-white text-lg"></i>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Show continue button inside the selection window
        setTimeout(() => {
          const selectionWindow = document.querySelector('.relative.h-40.sm\\:h-48.overflow-hidden') || 
                                  document.querySelector('.relative.overflow-hidden') ||
                                  document.querySelector('#lootboxContainer .relative');
          
          if (selectionWindow) {
            // Remove any existing button container first
            const existingButton = document.getElementById('continueButtonContainer');
            if (existingButton) {
              existingButton.remove();
            }
            
            // First, slide the beer card to the left
            const beerCard = document.querySelector('#beerSlider > div');
            if (beerCard) {
              beerCard.classList.add('card-slide-left');
            }
            
            // Create button container positioned to the right
            const buttonContainer = document.createElement('div');
            buttonContainer.id = 'continueButtonContainer';
            buttonContainer.className = 'absolute inset-0 flex items-center justify-end pr-2 sm:pr-8 z-20 pointer-events-none';
            buttonContainer.innerHTML = `
              <button 
                onclick="proceedToRating()" 
                class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-2 px-4 sm:py-3 sm:px-6 rounded-lg sm:rounded-xl text-base sm:text-lg transition-all transform hover:scale-110 shadow-lg button-appear pointer-events-auto"
              >
                Start <i class="fas fa-arrow-right ml-1 sm:ml-2 text-sm sm:text-base"></i>
              </button>
            `;
            
            // Add button to selection window
            selectionWindow.appendChild(buttonContainer);
            
            // After initial animation, add floating effects
            setTimeout(() => {
              const button = buttonContainer.querySelector('button');
              if (button) {
                button.classList.remove('button-appear');
                button.classList.add('button-animated');
              }
            }, 1000); // Increased timeout to be safer
          } else {
            // Fallback: if we can't find the container, add button to app
            console.warn('Could not find selection window, adding fallback button');
            const fallbackButton = document.createElement('div');
            fallbackButton.id = 'fallbackButton';
            fallbackButton.className = 'text-center mt-4';
            fallbackButton.innerHTML = `
              <button 
                onclick="proceedToRating()" 
                class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 px-6 rounded-xl text-lg transition-all transform hover:scale-110 shadow-lg"
              >
                Start <i class="fas fa-arrow-right ml-2"></i>
              </button>
            `;
            document.getElementById('app').appendChild(fallbackButton);
          }
        }, 1000); // Increased initial timeout
      }, 500);
    }
  }
  
  animate();
}

function proceedToRating() {
  // Clean up any existing buttons
  const continueButton = document.getElementById('continueButtonContainer');
  const fallbackButton = document.getElementById('fallbackButton');
  if (continueButton) continueButton.remove();
  if (fallbackButton) fallbackButton.remove();
  
  renderRound();
}

function renderRound() {
  // Only reset selectedScores if we're coming from a new round, not from going back
  if (!window.restoringFromHistory) {
    selectedScores = {};
  }
  window.restoringFromHistory = false;
  
  const activePlayers = state.players.filter(p => !p.eliminated);
  const remainingBeers = state.players.filter(p => !state.scores.some(s => s.beer === p.beer)).length - 1;
  const totalRounds = state.players.length;
  const completedRounds = state.scores.length;
  const progressPercentage = (completedRounds / totalRounds) * 100;
  
  app.innerHTML = `
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-4 sm:p-8 mt-4 sm:mt-8">
      <div class="flex justify-between items-center mb-4">
        ${state.roundHistory.length > 0 ? `
        <button 
          onclick="goBackOneRound()"
          class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-3 sm:px-4 rounded-lg transition-all text-sm sm:text-base no-print"
        >
          <i class="fas fa-arrow-left"></i> Terug
        </button>
        ` : '<div></div>'}
        <div class="text-center flex-1">
          <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-200">
            Ronde ${state.round}
          </h2>
          <p class="text-gray-600 dark:text-gray-400 text-sm sm:text-base">
            <i class="fas fa-beer"></i> Nog ${remainingBeers} ${remainingBeers === 1 ? 'ronde' : 'rondes'} te gaan
          </p>
        </div>
        <div></div>
      </div>
      
      <!-- Progress Bar -->
      <div class="mb-6">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm sm:text-base font-medium text-gray-700 dark:text-gray-300">Voortgang</span>
          <span class="text-sm sm:text-base font-medium text-gray-700 dark:text-gray-300">${completedRounds}/${totalRounds} rondes</span>
        </div>
        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-3 sm:h-4">
          <div class="bg-gradient-to-r from-amber-400 to-orange-500 h-3 sm:h-4 rounded-full transition-all duration-500 ease-out" style="width: ${progressPercentage}%"></div>
        </div>
        <div class="flex justify-between mt-2">
          ${Array.from({length: totalRounds}, (_, i) => `
            <div class="flex flex-col items-center">
              <div class="w-3 h-3 sm:w-4 sm:h-4 rounded-full ${i < completedRounds ? 'bg-green-500' : i === completedRounds ? 'bg-amber-500 pulse-animation' : 'bg-gray-300 dark:bg-gray-600'}"></div>
              <span class="text-xs text-gray-500 dark:text-gray-400 mt-1">${i + 1}</span>
            </div>
          `).join('')}
        </div>
      </div>
      
      <div class="text-center mb-6 sm:mb-8">
        <div class="bg-amber-100 dark:bg-gray-700 rounded-xl p-4 sm:p-6 inline-block">
          <h3 class="text-2xl sm:text-4xl font-bold text-amber-700 dark:text-amber-400 mb-2">${state.currentBeer.beer}</h3>
          <p class="text-gray-600 dark:text-gray-400 text-sm sm:text-base">
            <i class="fas fa-user"></i> Ingebracht door: <span class="font-semibold">${state.currentBeer.name}</span>
          </p>
        </div>
      </div>

      <form id="scoreForm" class="space-y-4 sm:space-y-6">
        ${activePlayers.map(p => `
          <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4 sm:p-6">
            <h4 class="text-lg sm:text-xl font-semibold text-gray-800 dark:text-gray-200 mb-3">
              <i class="fas fa-user-circle text-blue-500"></i> ${p.name}
            </h4>
            <div class="score-buttons grid grid-cols-5 sm:grid-cols-10 gap-1 sm:gap-2" data-player="${p.name}">
              ${[...Array(10).keys()].map(i => `
                <button 
                  type="button" 
                  data-score="${i + 1}"
                  class="score-btn bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-600 hover:border-amber-500 text-gray-700 dark:text-gray-300 font-bold py-2 sm:py-3 px-2 sm:px-4 rounded-lg transition-all transform hover:scale-110 text-sm sm:text-base"
                >
                  ${i + 1}
                </button>
              `).join('')}
            </div>
          </div>
        `).join('')}
        
        <button 
          type="submit"
          class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 sm:py-4 px-4 sm:px-6 rounded-lg text-lg sm:text-xl transition-all transform hover:scale-105"
        >
          <i class="fas fa-check-circle"></i> Bevestig Ronde
        </button>
      </form>
    </div>
  `;

  document.querySelectorAll('.score-buttons').forEach(group => {
    const player = group.dataset.player.trim().toLowerCase();
    
    // Restore previously selected score if any
    if (selectedScores[player]) {
      const selectedButton = group.querySelector(`[data-score="${selectedScores[player]}"]`);
      if (selectedButton) {
        selectedButton.classList.remove('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300', 'border-gray-300', 'dark:border-gray-600');
        selectedButton.classList.add('bg-amber-500', 'text-white', 'border-amber-600');
      }
    }
    
    group.addEventListener('click', function(e) {
      if (e.target.classList.contains('score-btn')) {
        const score = parseInt(e.target.dataset.score);
        const player = group.dataset.player.trim().toLowerCase();
        selectedScores[player] = score;
        
        group.querySelectorAll('button').forEach(btn => {
          btn.classList.remove('bg-amber-500', 'text-white', 'border-amber-600');
          btn.classList.add('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300', 'border-gray-300', 'dark:border-gray-600');
        });
        
        e.target.classList.remove('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300', 'border-gray-300', 'dark:border-gray-600');
        e.target.classList.add('bg-amber-500', 'text-white', 'border-amber-600', 'bounce-animation');
        
        setTimeout(() => e.target.classList.remove('bounce-animation'), 300);
      }
    });
  });

  document.getElementById('scoreForm').addEventListener('submit', function(e) {
    e.preventDefault();
    confirmRound();
  });
}

function confirmRound() {
  // Save current state before making changes
  saveRoundHistory();
  
  const round = {
    beer: state.currentBeer.beer,
    owner: state.currentBeer.name,
    scores: [],
    eliminated: []
  };

  for (const p of state.players) {
    if (p.eliminated) continue;
    if (selectedScores[p.name.trim().toLowerCase()]) {
      round.scores.push({ player: p.name, score: selectedScores[p.name.trim().toLowerCase()] });
    } else {
      p.eliminated = true;
      round.eliminated.push(p.name);
    }
  }

  state.scores.push(round);
  
  // Check if all players are eliminated
  const activePlayers = state.players.filter(p => !p.eliminated);
  if (activePlayers.length === 0) {
    renderResults();
  } else {
    nextRound();
  }
}

function renderResults() {
  const totalTime = ((Date.now() - state.startTime) / 1000).toFixed(0);
  const avgScoreByJudge = {};
  const allScores = {};
  const afvallers = [];
  const rondeVanAfval = {};

  state.scores.forEach((round, index) => {
    round.eliminated.forEach(name => {
      afvallers.push(name);
      rondeVanAfval[name] = index + 1;
    });

    round.scores.forEach(s => {
      if (!allScores[round.beer]) allScores[round.beer] = [];
      allScores[round.beer].push(s.score);

      if (!avgScoreByJudge[s.player]) avgScoreByJudge[s.player] = { total: 0, count: 0, given: [] };
      avgScoreByJudge[s.player].total += s.score;
      avgScoreByJudge[s.player].count++;
      avgScoreByJudge[s.player].given.push({ beer: round.beer, score: s.score });
    });
  });

  const avg = Object.entries(allScores).map(([beer, scores]) => {
    const owner = state.players.find(p => p.beer === beer).name;
    const average = (scores.reduce((a, b) => a + b, 0) / scores.length);
    return { beer, average: average, owner };
  }).sort((a, b) => b.average - a.average);

  // Find unrated/missed beers
  const ratedBeers = state.scores.map(r => r.beer);
  const unratedBeers = state.players.filter(p => !ratedBeers.includes(p.beer));
  
  // Find beers that had rounds but got no scores (everyone eliminated)
  const beersWithNoScores = state.scores.filter(round => round.scores.length === 0).map(r => ({
    name: r.owner,
    beer: r.beer
  }));
  
  // Combine both types of missed beers
  const allMissedBeers = [...unratedBeers, ...beersWithNoScores];

  const volhouders = state.players.filter(p => !p.eliminated);
  const earliestRound = Object.values(rondeVanAfval).length > 0 ? Math.min(...Object.values(rondeVanAfval)) : 1;
  const laffeBorrelaars = afvallers.filter(name => rondeVanAfval[name] === earliestRound);
  const lafste = laffeBorrelaars.length ? laffeBorrelaars : null;

  const bestBeer = avg.length > 0 ? avg[0] : null;
  const worstBeer = avg.length > 0 ? avg[avg.length - 1] : null;

  // Calculate achievements
  let mostGenerousJudge = null;
  let hardestCritic = null;
  
  if (Object.keys(avgScoreByJudge).length > 0) {
    // Most generous judge (highest average score given)
    const judgeAverages = Object.entries(avgScoreByJudge).map(([name, data]) => ({
      name,
      average: data.total / data.count
    }));
    
    mostGenerousJudge = judgeAverages.reduce((max, judge) => 
      judge.average > max.average ? judge : max
    );
    
    // Hardest critic (lowest average score given)
    hardestCritic = judgeAverages.reduce((min, judge) => 
      judge.average < min.average ? judge : min
    );
  }

  app.innerHTML = `
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-4 sm:p-8 mt-4 sm:mt-8">
      <div class="flex justify-between items-center mb-6 sm:mb-8 no-print">
        ${state.roundHistory.length > 0 ? `
        <button 
          onclick="goBackOneRound()"
          class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-3 sm:px-4 rounded-lg transition-all text-sm sm:text-base"
        >
          <i class="fas fa-arrow-left"></i> Terug
        </button>
        ` : '<div></div>'}
        <h1 class="text-3xl sm:text-5xl font-bold text-center text-amber-700 dark:text-amber-400 flex-1">
          <i class="fas fa-flag-checkered"></i> Eindresultaat
        </h1>
        <div></div>
      </div>
      
      <!-- 1. Main Results Cards -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8 no-print">
        ${bestBeer ? `
        <div class="bg-gradient-to-br from-green-400 to-green-600 text-white rounded-xl p-4 sm:p-6 text-center transform hover:scale-105 transition-transform">
          <i class="fas fa-trophy text-3xl sm:text-5xl mb-2 sm:mb-3"></i>
          <h3 class="text-lg sm:text-xl font-bold mb-2">Beste Bier</h3>
          <p class="text-lg sm:text-2xl font-bold">${bestBeer.beer}</p>
          <p class="text-sm sm:text-lg">Score: ${bestBeer.average.toFixed(2)}</p>
          <p class="text-xs sm:text-sm opacity-90">Door: ${bestBeer.owner}</p>
        </div>
        ` : ''}
        
        ${worstBeer ? `
        <div class="bg-gradient-to-br from-red-400 to-red-600 text-white rounded-xl p-4 sm:p-6 text-center transform hover:scale-105 transition-transform">
          <i class="fas fa-skull text-3xl sm:text-5xl mb-2 sm:mb-3"></i>
          <h3 class="text-lg sm:text-xl font-bold mb-2">Slechtste Bier</h3>
          <p class="text-lg sm:text-2xl font-bold">${worstBeer.beer}</p>
          <p class="text-sm sm:text-lg">Score: ${worstBeer.average.toFixed(2)}</p>
          <p class="text-xs sm:text-sm opacity-90">Door: ${worstBeer.owner}</p>
        </div>
        ` : ''}
        
        ${volhouders.length > 0 ? `
        <div class="bg-gradient-to-br from-blue-400 to-blue-600 text-white rounded-xl p-4 sm:p-6 text-center transform hover:scale-105 transition-transform">
          <i class="fas fa-fist-raised text-3xl sm:text-5xl mb-2 sm:mb-3"></i>
          <h3 class="text-lg sm:text-xl font-bold mb-2">Volhouders</h3>
          <div class="mt-3">
            <div class="grid grid-cols-1 gap-2">
              ${volhouders.map(p => `
                <div class="bg-white/20 rounded-lg px-3 py-1">
                  <span class="text-sm font-medium">${p.name}</span>
                </div>
              `).join('')}
            </div>
          </div>
          <p class="text-sm opacity-90 mt-2">Totaal: ${volhouders.length} speler(s)</p>
        </div>
        ` : ''}
        
        ${lafste ? `
        <div class="bg-gradient-to-br from-orange-400 to-orange-600 text-white rounded-xl p-6 text-center transform hover:scale-105 transition-transform">
          <i class="fas fa-dizzy text-5xl mb-3"></i>
          <h3 class="text-xl font-bold mb-2">Lafste Borrelaar(s)</h3>
          <div class="mt-3">
            <div class="grid grid-cols-1 gap-2">
              ${lafste.map(n => `
                <div class="bg-white/20 rounded-lg px-3 py-2">
                  <span class="text-sm font-medium">${n}</span>
                  <span class="text-xs opacity-80 ml-2">(Ronde ${rondeVanAfval[n]})</span>
                </div>
              `).join('')}
            </div>
          </div>
          <p class="text-sm opacity-90 mt-2">Totaal: ${lafste.length} speler(s)</p>
        </div>` : ''}
      </div>

      <!-- 2. Achievement Cards -->
      ${mostGenerousJudge || hardestCritic ? `
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6 mb-6 sm:mb-8 no-print">
        ${mostGenerousJudge ? `
        <div class="bg-gradient-to-br from-emerald-400 to-green-500 text-white rounded-xl p-4 sm:p-6 text-center transform hover:scale-105 transition-transform">
          <i class="fas fa-heart text-3xl sm:text-4xl mb-2 sm:mb-3"></i>
          <h3 class="text-lg sm:text-xl font-bold mb-2">Meest Genereuze Beoordelaar</h3>
          <p class="text-lg sm:text-xl font-bold">${mostGenerousJudge.name}</p>
          <p class="text-sm sm:text-base opacity-90">Gemiddeld ${mostGenerousJudge.average.toFixed(1)} punten gegeven</p>
          <div class="mt-2">
            <i class="fas fa-award text-yellow-300"></i>
          </div>
        </div>
        ` : ''}
        
        ${hardestCritic ? `
        <div class="bg-gradient-to-br from-purple-500 to-indigo-600 text-white rounded-xl p-4 sm:p-6 text-center transform hover:scale-105 transition-transform">
          <i class="fas fa-gavel text-3xl sm:text-4xl mb-2 sm:mb-3"></i>
          <h3 class="text-lg sm:text-xl font-bold mb-2">Hardste Criticus</h3>
          <p class="text-lg sm:text-xl font-bold">${hardestCritic.name}</p>
          <p class="text-sm sm:text-base opacity-90">Gemiddeld ${hardestCritic.average.toFixed(1)} punten gegeven</p>
          <div class="mt-2">
            <i class="fas fa-medal text-gray-300"></i>
          </div>
        </div>
        ` : ''}
      </div>
      ` : ''}

      <!-- 2. Round Breakdown -->
      <div class="bg-indigo-50 dark:bg-gray-700 rounded-xl p-4 sm:p-6 mb-6 sm:mb-8 no-print">
        <h3 class="text-xl sm:text-2xl font-bold text-indigo-800 dark:text-indigo-400 mb-4">
          <i class="fas fa-history"></i> Ronden Breakdown
        </h3>
        <div class="space-y-4">
          ${state.scores.map((round, index) => {
            const participants = round.scores.map(s => s.player);
            const eliminated = round.eliminated;
            const avgScore = round.scores.length > 0 ? (round.scores.reduce((sum, s) => sum + s.score, 0) / round.scores.length).toFixed(1) : 'N/A';
            
            // Calculate round duration
            let roundDuration = 'Onbekend';
            if (state.roundHistory.length > index + 1) {
              const startTime = index === 0 ? state.startTime : state.roundHistory[index].timestamp;
              const endTime = state.roundHistory[index + 1].timestamp;
              const duration = Math.floor((endTime - startTime) / 1000);
              roundDuration = duration < 60 ? `${duration}s` : `${Math.floor(duration / 60)}m ${duration % 60}s`;
            }
            
            return `
              <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border-2 border-indigo-200 dark:border-indigo-600">
                <div class="flex justify-between items-start mb-3">
                  <h4 class="text-lg font-semibold text-indigo-700 dark:text-indigo-400">
                    <i class="fas fa-circle-dot"></i> Ronde ${index + 1}
                  </h4>
                  <span class="text-sm text-gray-500 dark:text-gray-400">
                    <i class="fas fa-clock"></i> ${roundDuration}
                  </span>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-3">
                  <div class="bg-amber-50 dark:bg-amber-900 rounded-lg p-3">
                    <p class="text-sm font-medium text-amber-800 dark:text-amber-300">Bier</p>
                    <p class="text-lg font-bold text-amber-900 dark:text-amber-100">${round.beer}</p>
                    <p class="text-xs text-gray-600 dark:text-gray-400">Door: ${round.owner}</p>
                  </div>
                  <div class="bg-green-50 dark:bg-green-900 rounded-lg p-3">
                    <p class="text-sm font-medium text-green-800 dark:text-green-300">Deelnemers</p>
                    <p class="text-lg font-bold text-green-900 dark:text-green-100">${participants.length}</p>
                    <p class="text-xs text-gray-600 dark:text-gray-400">${participants.join(', ')}</p>
                  </div>
                  <div class="bg-blue-50 dark:bg-blue-900 rounded-lg p-3">
                    <p class="text-sm font-medium text-blue-800 dark:text-blue-300">Gem. Score</p>
                    <p class="text-lg font-bold text-blue-900 dark:text-blue-100">${avgScore}</p>
                    <p class="text-xs text-gray-600 dark:text-gray-400">${round.scores.length} beoordelingen</p>
                  </div>
                  <div class="bg-red-50 dark:bg-red-900 rounded-lg p-3">
                    <p class="text-sm font-medium text-red-800 dark:text-red-300">Afvallers</p>
                    <p class="text-lg font-bold text-red-900 dark:text-red-100">${eliminated.length}</p>
                    <p class="text-xs text-gray-600 dark:text-gray-400">${eliminated.length > 0 ? eliminated.join(', ') : 'Geen'}</p>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>

      <!-- 3. Beer Ranking -->
      ${avg.length > 0 ? `
      <div class="bg-amber-50 dark:bg-gray-700 rounded-xl p-6 mb-8 no-print">
        <h3 class="text-2xl font-bold text-amber-800 dark:text-amber-400 mb-4">
          <i class="fas fa-list-ol"></i> Volledige Bier Ranking
        </h3>
        <div class="space-y-3">
          ${avg.map((b, i) => {
            const medal = i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : `#${i + 1}`;
            const bgColor = i === 0 ? 'bg-gradient-to-r from-yellow-100 to-yellow-200 dark:from-yellow-900 dark:to-yellow-800' : 
                           i === 1 ? 'bg-gradient-to-r from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-600' : 
                           i === 2 ? 'bg-gradient-to-r from-orange-100 to-orange-200 dark:from-orange-900 dark:to-orange-800' : 'bg-white dark:bg-gray-800';
            return `
              <div class="${bgColor} rounded-lg p-4 flex items-center justify-between border-2 border-gray-200 dark:border-gray-600">
                <div class="flex items-center gap-4">
                  <span class="text-2xl font-bold text-gray-800 dark:text-gray-200">${medal}</span>
                  <div>
                    <p class="text-lg font-semibold text-gray-800 dark:text-gray-200">${b.beer}</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Door: ${b.owner}</p>
                  </div>
                </div>
                <div class="text-right">
                  <p class="text-2xl font-bold text-amber-600 dark:text-amber-400">${b.average.toFixed(2)}</p>
                  <p class="text-sm text-gray-600 dark:text-gray-400">gemiddeld</p>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
      ` : ''}

      <!-- 4. Missed Beers -->
      ${allMissedBeers.length > 0 ? `
      <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4 sm:p-6 mb-6 sm:mb-8 no-print">
        <h3 class="text-xl sm:text-2xl font-bold text-gray-800 dark:text-gray-200 mb-4">
          <i class="fas fa-question-circle"></i> Gemiste Bieren
        </h3>
        <p class="text-gray-600 dark:text-gray-400 mb-4 text-sm sm:text-base">Deze bieren zijn niet beoordeeld omdat iedereen al was afgevallen of niet aan bod gekomen:</p>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
          ${allMissedBeers.map(p => `
            <div class="bg-white dark:bg-gray-800 rounded-lg p-3 sm:p-4 border-2 border-gray-300 dark:border-gray-600 border-dashed">
              <div class="flex items-center gap-3">
                <i class="fas fa-beer text-2xl sm:text-3xl text-gray-400"></i>
                <div class="flex-1">
                  <p class="font-semibold text-gray-700 dark:text-gray-300 text-sm sm:text-base">${p.beer}</p>
                  <p class="text-xs sm:text-sm text-gray-500 dark:text-gray-400">Door: ${p.name}</p>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
        <p class="text-center text-gray-600 dark:text-gray-400 mt-4 text-sm sm:text-base">
          Totaal: ${allMissedBeers.length} gemiste ${allMissedBeers.length === 1 ? 'bier' : 'bieren'}
        </p>
      </div>
      ` : ''}

      <!-- 5. Players -->
      <div class="bg-green-50 dark:bg-gray-700 rounded-xl p-4 sm:p-6 mb-6 sm:mb-8 no-print">
        <h3 class="text-xl sm:text-2xl font-bold text-green-800 dark:text-green-400 mb-4">
          <i class="fas fa-users"></i> Alle Deelnemers
        </h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
          ${state.players.map(p => `
            <div class="bg-white dark:bg-gray-800 rounded-lg p-3 sm:p-4 border-2 border-green-200 dark:border-green-600 flex items-center gap-3">
              <i class="fas fa-user-circle text-2xl text-green-600 dark:text-green-400"></i>
              <div class="flex-1">
                <p class="font-semibold text-green-800 dark:text-green-400 text-sm sm:text-base">${p.name}</p>
                <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 flex items-center gap-1">
                  <i class="fas fa-beer text-amber-600 dark:text-amber-400"></i>
                  ${p.beer}
                </p>
              </div>
              ${p.eliminated ? `
                <div class="text-red-500">
                  <i class="fas fa-times-circle" title="Afgevallen"></i>
                </div>
              ` : `
                <div class="text-green-500">
                  <i class="fas fa-check-circle" title="Volgehouden"></i>
                </div>
              `}
            </div>
          `).join('')}
        </div>
        <p class="text-center text-gray-600 dark:text-gray-400 mt-4 text-sm sm:text-base">
          Totaal: ${state.players.length} deelnemers
        </p>
      </div>

      <!-- 6. Judge Statistics -->
      ${Object.keys(avgScoreByJudge).length > 0 ? `
      <div class="bg-blue-50 dark:bg-gray-700 rounded-xl p-4 sm:p-6 mb-6 sm:mb-8 no-print">
        <h3 class="text-xl sm:text-2xl font-bold text-blue-800 dark:text-blue-400 mb-4">
          <i class="fas fa-chart-bar"></i> Beoordelaarsstatistieken
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          ${Object.entries(avgScoreByJudge).map(([name, data]) => {
            const avgScore = (data.total / data.count).toFixed(2);
            return `
              <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border-2 border-blue-200 dark:border-blue-600">
                <h4 class="text-lg font-semibold text-blue-700 dark:text-blue-400 mb-2">
                  <i class="fas fa-user"></i> ${name}
                </h4>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Gemiddelde score gegeven: <span class="font-bold text-blue-600 dark:text-blue-400 text-lg">${avgScore}</span></p>
                <div class="space-y-1">
                  ${data.given.map(g => `
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-600 dark:text-gray-400">${g.beer}:</span>
                      <span class="font-semibold text-gray-800 dark:text-gray-200">${g.score}</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
      ` : ''}

      <!-- End of sections -->


      <div class="text-center mb-8 no-print">
        <p class="text-lg text-gray-600 dark:text-gray-400">
          <i class="fas fa-clock"></i> Totale speeltijd: 
          <span class="font-bold">${Math.floor(totalTime / 60)} minuten en ${totalTime % 60} seconden</span>
        </p>
      </div>
      
      <!-- Print-only content - Completely different layout for print -->
      <div class="print-only" style="display: none;">
        <!-- Print Header -->
        <div class="print-header">
          <div class="print-title">High Bieren Spel - Resultaten</div>
          <div class="print-subtitle">Datum: ${new Date().toLocaleDateString('nl-NL')} | Speeltijd: ${Math.floor(totalTime / 60)} minuten</div>
        </div>

        <!-- Summary Section -->
        <div class="print-summary">
          <h3>Samenvatting</h3>
          <div class="print-two-column">
            <div>
              <strong>Totaal aantal spelers:</strong> ${state.players.length}<br>
              <strong>Aantal rondes gespeeld:</strong> ${state.scores.length}<br>
              <strong>Aantal volhouders:</strong> ${volhouders.length}
            </div>
            <div>
              ${bestBeer ? `<strong>Beste bier:</strong> ${bestBeer.beer} (${bestBeer.average.toFixed(2)})<br>` : ''}
              ${worstBeer ? `<strong>Slechtste bier:</strong> ${worstBeer.beer} (${worstBeer.average.toFixed(2)})<br>` : ''}
              <strong>Totale speeltijd:</strong> ${Math.floor(totalTime / 60)} minuten
            </div>
          </div>
        </div>

        <!-- Achievement Cards in Print -->
        ${(mostGenerousJudge || hardestCritic || bestBeer || worstBeer || volhouders.length > 0 || (lafste && lafste.length > 0)) ? `
        <div class="print-section">
          <h2>Behaalde Prestaties</h2>
          <table class="print-table">
            <tr>
              <th>Prestatie</th>
              <th>Winnaar</th>
              <th>Details</th>
            </tr>
            ${bestBeer ? `
            <tr>
              <td>Beste Bier</td>
              <td>${bestBeer.beer}</td>
              <td>Gemiddelde: ${bestBeer.average.toFixed(2)} | Door: ${bestBeer.owner}</td>
            </tr>` : ''}
            ${worstBeer ? `
            <tr>
              <td>Slechtste Bier</td>
              <td>${worstBeer.beer}</td>
              <td>Gemiddelde: ${worstBeer.average.toFixed(2)} | Door: ${worstBeer.owner}</td>
            </tr>` : ''}
            ${volhouders.length > 0 ? `
            <tr>
              <td>Volhouders</td>
              <td>${volhouders.map(p => p.name).join(', ')}</td>
              <td>Hebben alle rondes overleefd</td>
            </tr>` : ''}
            ${lafste && lafste.length > 0 ? `
            <tr>
              <td>Lafste Borrelaar(s)</td>
              <td>${lafste.join(', ')}</td>
              <td>Afgevallen in ronde ${earliestRound}</td>
            </tr>` : ''}
            ${mostGenerousJudge ? `
            <tr>
              <td>Meest Genereuze Beoordelaar</td>
              <td>${mostGenerousJudge.name}</td>
              <td>Gemiddelde score gegeven: ${mostGenerousJudge.average.toFixed(2)}</td>
            </tr>` : ''}
            ${hardestCritic ? `
            <tr>
              <td>Hardste Criticus</td>
              <td>${hardestCritic.name}</td>
              <td>Gemiddelde score gegeven: ${hardestCritic.average.toFixed(2)}</td>
            </tr>` : ''}
          </table>
        </div>` : ''}

        <!-- Round Breakdown -->
        ${state.roundHistory.length > 0 ? `
        <div class="print-section page-break">
          <h2>Rondes Overzicht</h2>
          <table class="print-table">
            <tr>
              <th>Ronde</th>
              <th>Bier</th>
              <th>Eigenaar</th>
              <th>Deelnemers</th>
              <th>Afvallers</th>
              <th>Duur</th>
            </tr>
            ${state.roundHistory.map((round, index) => {
              const roundData = state.scores[index];
              if (!roundData) return '';
              
              const duration = index < state.roundHistory.length - 1 
                ? Math.round((state.roundHistory[index + 1].timestamp - round.timestamp) / 1000)
                : Math.round((Date.now() - round.timestamp) / 1000);
              
              const participants = roundData.scores.map(s => s.player);
              const eliminated = roundData.eliminated;
              
              return `
              <tr>
                <td>${index + 1}</td>
                <td>${roundData.beer}</td>
                <td>${roundData.owner}</td>
                <td>${participants.join(', ')}</td>
                <td>${eliminated.length > 0 ? eliminated.join(', ') : 'Geen'}</td>
                <td>${Math.floor(duration / 60)}:${(duration % 60).toString().padStart(2, '0')}</td>
              </tr>`;
            }).join('')}
          </table>
        </div>` : ''}

        <!-- Beer Ranking -->
        ${avg.length > 0 ? `
        <div class="print-section">
          <h2>Bier Ranking</h2>
          <table class="print-table">
            <tr>
              <th>Positie</th>
              <th>Bier</th>
              <th>Gemiddelde Score</th>
              <th>Eigenaar</th>
            </tr>
            ${avg.map((beer, index) => `
            <tr>
              <td>#${index + 1}</td>
              <td>${beer.beer}</td>
              <td>${beer.average.toFixed(2)}</td>
              <td>${beer.owner}</td>
            </tr>
            `).join('')}
          </table>
        </div>` : ''}

        <!-- Missed Beers -->
        ${allMissedBeers.length > 0 ? `
        <div class="print-section">
          <h2>Gemiste Bieren</h2>
          <div class="print-list">
            ${allMissedBeers.map(beer => `
              <div class="print-list-item">${beer.beer} (van ${beer.name})</div>
            `).join('')}
          </div>
          <p><em>Totaal gemiste bieren: ${allMissedBeers.length}</em></p>
        </div>` : ''}

        <!-- Participants -->
        <div class="print-section">
          <h2>Deelnemers</h2>
          <table class="print-table">
            <tr>
              <th>Naam</th>
              <th>Meegebracht Bier</th>
              <th>Status</th>
              <th>Afgevallen in Ronde</th>
            </tr>
            ${state.players.map(player => `
            <tr>
              <td>${player.name}</td>
              <td>${player.beer}</td>
              <td>${player.eliminated ? 'Afgevallen' : 'Volgehouden'}</td>
              <td>${player.eliminated ? (rondeVanAfval[player.name] || 'Onbekend') : '-'}</td>
            </tr>
            `).join('')}
          </table>
        </div>

        <!-- Judge Statistics -->
        ${Object.keys(avgScoreByJudge).length > 0 ? `
        <div class="print-section">
          <h2>Beoordelaarsstatistieken</h2>
          <table class="print-table">
            <tr>
              <th>Beoordelaar</th>
              <th>Gemiddelde Score Gegeven</th>
              <th>Aantal Beoordelingen</th>
              <th>Beoordelingen Details</th>
            </tr>
            ${Object.entries(avgScoreByJudge).map(([name, data]) => `
            <tr>
              <td>${name}</td>
              <td>${(data.total / data.count).toFixed(2)}</td>
              <td>${data.count}</td>
              <td>${data.given.map(g => `${g.beer}: ${g.score}`).join(', ')}</td>
            </tr>
            `).join('')}
          </table>
        </div>` : ''}
      </div>

      <!-- Action buttons (hidden when printing) -->
      <div class="flex flex-col sm:flex-row gap-3 no-print">
        <button 
          onclick="window.print()"
          class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-lg text-lg transition-all transform hover:scale-105"
        >
          <i class="fas fa-print mr-2"></i> Print Resultaten
        </button>
        
        <button 
          onclick="location.reload()"
          class="flex-1 bg-amber-500 hover:bg-amber-600 text-white font-bold py-4 px-6 rounded-lg text-lg transition-all transform hover:scale-105"
        >
          <i class="fas fa-redo mr-2"></i> Opnieuw Spelen
        </button>
      </div>
    </div>
  `;
}

// Settings menu functionality
function toggleSettingsPanel() {
  const panel = document.getElementById('settingsPanel');
  panel.classList.toggle('open');
}

// Dark mode functionality
function toggleDarkMode() {
  state.darkMode = !state.darkMode;
  localStorage.setItem('darkMode', state.darkMode);
  updateDarkMode();
  updateSettingsPanel();
  // Dark mode changes are applied via CSS classes - no re-rendering needed
}

function updateDarkMode() {
  if (state.darkMode) {
    document.documentElement.classList.add('dark');
  } else {
    document.documentElement.classList.remove('dark');
  }
  
  // Update slider appearance
  const slider = document.getElementById('darkModeSlider');
  if (slider) {
    if (state.darkMode) {
      slider.classList.add('active');
    } else {
      slider.classList.remove('active');
    }
  }
}

function updateSettingsPanel() {
  const panel = document.getElementById('settingsPanel');
  if (panel) {
    const themeStatus = panel.querySelector('.text-xs');
    if (themeStatus) {
      themeStatus.textContent = state.darkMode ? 'Donker thema actief' : 'Licht thema actief';
    }
  }
}

// Initialize dark mode on page load
updateDarkMode();

renderSetup();
  </script>
</body>
</html>
